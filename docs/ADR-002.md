# ADR-002: Tilgangsmodell og rate limiting

**Status:** Akseptert
**Dato:** 2026-02-07
**Beslutningstagere:** Utviklingsteam
**Kontekst:** Tilgangskontroll for Paragraf MCP-server

---

## Sammendrag

Dette dokumentet beskriver arkitekturbeslutningene for tilgangsmodell og rate limiting i Paragraf MCP-serveren. Formålet er å gi åpen tilgang til lovdata med beskyttelse mot misbruk.

---

## ADR-002.1: Tilgangsmodell

### Kontekst

MCP-serveren eksponerer offentlig lovdata (NLOD 2.0). Det er ønskelig å holde tjenesten åpen, men beskytte mot misbruk.

### Alternativer vurdert

| Alternativ | Friksjon | Beskyttelse | Kompleksitet |
|------------|----------|-------------|--------------|
| A: Helt åpen (ingen auth) | Ingen | Ingen | Minimal |
| B: Kun API-nøkkel (registrering påkrevd) | Høy | God | Lav |
| C: To nivåer (anonym + registrert) | Lav | God | Medium |
| D: Betalt abonnement | Høy | Meget god | Høy |

### Beslutning

**Valgt: Åpent med burst-begrensning (revidert fra C)**

| Brukertype | Auth | Begrensning | Bruksscenario |
|------------|------|-------------|---------------|
| **Alle** | Ingen | 120 req/min per IP | Alle bruksscenarioer |

Opprinnelig plan var to nivåer (200 oppslag/mnd for anonyme, ubegrenset for API-nøkkel). Dette ble forkastet fordi:

1. **IP ≠ bruker:** CGNAT (mobilnett), universitets-WiFi og VPN gjør IP-basert månedlig kvote meningsløs — én IP kan representere tusenvis av brukere
2. **Månedlig kvote krever persistent state:** Redis eller database for tellere, som øker Supabase-belastning — det motsatte av hensikten
3. **Kvote beskytter ikke mot det faktiske problemet:** En bruker med 199 gjenværende oppslag kan fyre av alle på 1 sekund. Connection pool bryr seg om *samtidighet*, ikke totalt volum

Burst-begrensning (120 req/min per IP) beskytter connection pool uten å ramme delte nettverk. Se ADR-002.2 for detaljer.

### Begrunnelse

- **Lav friksjon:** Ingen registrering, ingen kvote, ingen API-nøkkel påkrevd
- **Offentlige data:** Lovdata er offentlig under NLOD 2.0 — bør være tilgjengelig
- **Riktig beskyttelse:** Burst-limit beskytter Supabase connection pool (60 connections delt med annet prosjekt)
- **Delte nettverk:** 120/min per IP gir plass til ~12 samtidige brukere bak NAT

### Konsekvenser

| Type | Konsekvens |
|------|------------|
| Positiv | Ingen barriere for nye brukere |
| Positiv | Beskytter connection pool mot utilsiktet overbelastning |
| Positiv | Ingen ekstra infrastruktur (in-memory, ingen Redis) |
| Negativ | Per-IP limit kan teoretisk ramme >12 samtidige brukere bak streng NAT |

---

## ADR-002.2: Rate limiting

### Kontekst

Paragraf deler Supabase-instans med unified-timeline (60 samtidige connections via pgbouncer). Et script som sender 100 req/sek kan tømme connection pool og ta ned begge prosjektene.

Dataene er offentlige (NLOD 2.0), så rate limiting handler ikke om tilgangskontroll, men om infrastrukturbeskyttelse.

### Alternativer vurdert

| Alternativ | Beskytter pool? | NAT-vennlig? | Ekstra infra? |
|------------|----------------|--------------|---------------|
| A: 200 oppslag/mnd per IP | Nei (burst mulig) | Nei (CGNAT) | Ja (Redis/DB) |
| B: 120 req/min per IP (burst) | Ja | Ja (~12 brukere) | Nei (in-memory) |
| C: Per-bruker kvote (krever auth) | Ja | Ja | Ja (auth + DB) |
| D: Global concurrency-semaphore | Ja | Ja | Nei |

### Beslutning

**Valgt: B — 120 req/min per IP via Flask-Limiter**

Implementert som `@limit_mcp`-decorator i unified-timeline sin `rate_limiter.py`, brukt på MCP POST-endepunktet. Følger eksisterende mønster (`limit_submit`, `limit_webhook`).

### Kapasitetsberegning

```
Supabase connections:     60 (delt)
Paragraf sin andel:       ~30 (konservativt)
Typisk query-tid:         6ms (warm), ~50ms (cold)
Maks throughput:          ~300 req/sek (med sikkermargin)

Legitimt bruksmønster:
  MCP-samtale:            2-5 oppslag over 30 sek → ~10 req/min
  50 studenter på UiO:    50 × 10 = 500 req/min fra én IP → 8.3 req/sek
  120 req/min grense:     Gir plass til ~12 samtidige brukere per IP
```

### Tekniske valg

| Valg | Beslutning | Begrunnelse |
|------|-----------|-------------|
| Storage | `memory://` | Ingen Redis-avhengighet, OK med 1 worker |
| Strategy | `fixed-window` | Lavest ressursbruk |
| Gunicorn | 1 worker, 4 threads | Threads deler minne → rate limits teller korrekt |
| Exempt paths | `/mcp/health`, `/mcp/info` | Ingen DB-query, skal ikke rate-limites |

### Konsekvenser

| Type | Konsekvens |
|------|------------|
| Positiv | Beskytter connection pool med ~10 linjer kode |
| Positiv | Ingen ekstra infrastruktur eller dependencies |
| Positiv | Rate limit state overlever ikke restart — akseptabelt for burst-beskyttelse |
| Negativ | In-memory = mister state ved deploy (akseptabelt) |

---

## Referanser

- [ADR-001: Lovdata MCP Arkitektur](./ADR-001.md)
